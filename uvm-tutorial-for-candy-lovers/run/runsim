#!/usr/bin/env ruby
require 'pp'
require 'optparse'
require 'ostruct'

options = OpenStruct.new
options.sim = "incisive" 
options.output = "tutorial_9.dat"

OptionParser.new do |opts|
  opts.banner = "Usage: runsim [-s <simulator=incisie>]"

  opts.on("-s", "--sim simulator",
          "Name of simulator to use") do |sim|
    options.sim = sim
  end

  opts.on("-o", "--output filename", "Output testname") do |name|
    options.output = name
  end

end.parse(ARGV)
sim = options.sim
output = options.output

def runtest(n, sim)
  output_name = "tutorial_9_n#{n}"
  puts `../src/mk_tutorial_9 -n #{n} -o #{output_name}.sv`
  puts "Running #{sim} with #{output_name}.sv"
  puts
  log_file = "#{sim}_#{output_name}.log"
  `rm -rf #{log_file}`
  `make #{sim} TEST=#{output_name}`
  abort "Log file #{log_file} not found" unless File.exist?(log_file)
  memory_usage = `grep Memory #{log_file}`
  md = /\= ([\d\.]+)M total/.match(memory_usage)
  abort "Could not extract memory usage" unless md
  return md[1].to_f
end

benchmark = {}

n = 1
6.times do
  benchmark[n] = runtest(n, sim)
  n = n * 10
end

#Generate 100K to 500
2.upto(5) do |i|
  n = 100000 * i
  benchmark[n] = runtest(n, sim)
end

File.open(output, "w") do |fh|
  fh.puts "NumberOfReg,MemoryMB"
  benchmark.each do |key, value|
    fh.puts "#{key}, #{value}"
  end
end

